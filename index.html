<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¤æ„Ÿç”Ÿæ´» | æ¾†æ°´æé†’</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ SortableJS (æ‹–æ›³åŠŸèƒ½) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        nature: {
                            50: '#f7f9f7',
                            100: '#eef2ee',
                            200: '#dbe5db',
                            300: '#bccdbc',
                            400: '#96ad96',
                            500: '#759075',
                            600: '#5c735c',
                            700: '#4a5c4a',
                            800: '#3d4a3d',
                            900: '#333d33',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f5f5f4; /* Stone 100 */
            background-image: radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 20px 20px;
            /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
            overscroll-behavior-y: none;
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a29e; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #78716c; 
        }

        /* å¡ç‰‡é€²å ´å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-enter {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* æ¾†æ°´æŒ‰éˆ•æ³¢ç´‹æ•ˆæœ */
        .water-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .water-btn:active {
            transform: scale(0.95);
        }
        
        /* åœ–ç‰‡è¼‰å…¥éæ¸¡ */
        .plant-img {
            transition: transform 0.5s ease;
        }
        .plant-card:hover .plant-img {
            transform: scale(1.05);
        }

        /* å‚™è¨»æ¬„ä½çš„æ²è»¸ */
        textarea {
            resize: none;
        }

        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e7e5e4;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        
        /* ç•¶å•Ÿç”¨æ‹–æ›³æ™‚çš„å¡ç‰‡æ¸¸æ¨™ */
        .draggable-card {
            cursor: grab;
        }
        .draggable-card:active {
            cursor: grabbing;
        }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #759075;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-stone-700 min-h-screen flex flex-col">

    <!-- é ‚éƒ¨å°èˆªèˆ‡æ¨™é¡Œ -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-stone-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-nature-500 text-white p-2 rounded-lg shadow-lg">
                    <i class="fa-solid fa-leaf text-xl"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-nature-800">æ¤æ„Ÿç”Ÿæ´» <span class="text-sm font-normal text-stone-500 hidden sm:inline-block ml-2">æ¤ç‰©æ¾†æ°´ç®¡å®¶</span></h1>
            </div>
            <button onclick="openAddModal()" class="bg-nature-600 hover:bg-nature-700 text-white px-5 py-2.5 rounded-full font-medium transition shadow-md flex items-center gap-2 text-sm md:text-base group">
                <i class="fa-solid fa-plus transition-transform group-hover:rotate-90"></i> æ–°å¢æ¤ç‰©
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-6xl mx-auto w-full">
        
        <!-- æ–°å¢/ç·¨è¼¯æ¤ç‰©è¡¨å–® (é è¨­éš±è—) -->
        <!-- ä¿®æ”¹èªªæ˜ï¼š
             1. åŠ ä¸Š z-[60] ç¢ºä¿åœ¨æœ€ä¸Šå±¤
             2. ä½¿ç”¨ fixed inset-0 æ»¿ç‰ˆé®ç½©
        -->
        <div id="formModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-stone-900/50 backdrop-blur-sm transition-opacity opacity-0">
            <!-- ä¿®æ”¹èªªæ˜ï¼š
                 1. max-h-[90vh] æ”¹ç‚º max-h-[90dvh] ä»¥é©æ‡‰æ‰‹æ©Ÿå‹•æ…‹ç¶²å€åˆ—
                 2. ç¢ºä¿ flex flex-col è®“å…§éƒ¨å¯ä»¥æ²å‹•
            -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl transform transition-all scale-95 flex flex-col max-h-[90dvh]" id="formContent">
                <div class="flex justify-between items-center mb-6 border-b border-stone-100 pb-4 flex-shrink-0">
                    <h2 id="formTitle" class="text-xl font-bold text-stone-800 flex items-center gap-2">
                        <i class="fa-solid fa-seedling text-nature-500"></i> æ–°å¢æ‚¨çš„ç¶ è‰²å¤¥ä¼´
                    </h2>
                    <button onclick="closeForm()" class="text-stone-400 hover:text-stone-600 transition p-2 rounded-full hover:bg-stone-100">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <!-- ä¿®æ”¹èªªæ˜ï¼š
                     1. åŠ å…¥ overscroll-contain é˜²æ­¢æ»‘å‹•åˆ°åº•éƒ¨æ™‚æ²å‹•åˆ°ä¸»é é¢
                     2. custom-scrollbar ä¿ç•™è‡ªå®šç¾©æ²è»¸æ¨£å¼
                -->
                <div class="overflow-y-auto pr-2 custom-scrollbar flex-grow overscroll-contain">
                    <form id="plantForm" onsubmit="handleFormSubmit(event)" class="space-y-5">
                        <input type="hidden" id="editPlantId">

                        <!-- ç¬¬ä¸€è¡Œï¼šåç¨±èˆ‡é »ç‡ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-stone-600 mb-1">æ¤ç‰©æš±ç¨±</label>
                                <input type="text" id="plantName" required placeholder="ä¾‹å¦‚ï¼šé¾œèƒŒèŠ‹" 
                                    class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-nature-400 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-stone-600 mb-1">æ¾†æ°´é »ç‡ (å¤©)</label>
                                <div class="relative">
                                    <input type="number" id="waterFreq" required min="1" max="365" placeholder="ä¾‹å¦‚ï¼š7" 
                                        class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-nature-400 focus:bg-white transition">
                                    <span class="absolute right-4 top-2.5 text-stone-400 text-sm">å¤©/æ¬¡</span>
                                </div>
                            </div>
                        </div>

                        <!-- ç¬¬äºŒè¡Œï¼šä¸Šæ¬¡æ¾†æ°´æ—¥æœŸèˆ‡å‚™è¨» -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-stone-600 mb-1">ä¸Šæ¬¡æ¾†æ°´æ—¥æœŸ</label>
                                <input type="date" id="lastWateredDate" required
                                    class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-nature-400 focus:bg-white transition text-stone-600">
                            </div>
                            <div class="md:row-span-2">
                                 <label class="block text-sm font-medium text-stone-600 mb-1">å‚™è¨» (é¸å¡«)</label>
                                 <textarea id="plantNotes" rows="4" placeholder="ä¾‹å¦‚ï¼šæ”¾åœ¨é™½å°ï¼Œéœ€è¦å¤šä¸€é»é™½å…‰..."
                                    class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-nature-400 focus:bg-white transition"></textarea>
                            </div>
                        </div>

                        <!-- åœ–ç‰‡é¸æ“‡ -->
                        <div>
                             <label class="block text-sm font-medium text-stone-600 mb-3">é¸æ“‡å¤–è§€</label>
                             
                             <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡† -->
                             <input type="file" id="imageUploadInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                             
                             <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3" id="iconSelector">
                                <!-- JS æœƒè‡ªå‹•ç”¢ç”Ÿé¸é … -->
                             </div>
                             <input type="hidden" id="selectedIcon" value="plant-1">
                             <input type="hidden" id="customImageData" value="">
                        </div>
                    </form>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-stone-100 mt-2 flex-shrink-0">
                    <button type="button" onclick="closeForm()" class="px-6 py-2.5 rounded-xl text-stone-500 hover:bg-stone-100 font-medium transition">å–æ¶ˆ</button>
                    <button onclick="document.getElementById('plantForm').requestSubmit()" class="px-8 py-2.5 bg-nature-600 hover:bg-nature-700 text-white rounded-xl shadow-lg shadow-nature-200 font-medium transition transform hover:-translate-y-0.5 flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> <span id="submitBtnText">åŠ å…¥æ¸…å–®</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆªé™¤ç¢ºèª Modal -->
        <div id="deleteModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-stone-900/50 backdrop-blur-sm transition-opacity opacity-0">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-95 text-center" id="deleteModalContent">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                    <i class="fa-solid fa-trash-can text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-stone-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                <p class="text-stone-500 text-sm mb-6">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸé€™å€‹æ¤ç‰©å¤¥ä¼´çš„è³‡æ–™ã€‚</p>
                
                <div class="flex gap-3 justify-center">
                    <button onclick="closeDeleteModal()" class="px-5 py-2.5 rounded-xl text-stone-500 hover:bg-stone-100 font-medium transition">å–æ¶ˆ</button>
                    <button onclick="confirmDelete()" class="px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl shadow-lg shadow-red-200 font-medium transition">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆèˆ‡ç¯©é¸æŒ‰éˆ• -->
        <div id="statsBar" class="mb-6 flex flex-wrap items-center gap-3 hidden">
            <span class="text-stone-500 text-sm font-medium mr-1">ç¯©é¸ç‹€æ…‹ï¼š</span>
            
            <button onclick="setFilter('all')" id="btn-filter-all" 
                class="px-4 py-2 rounded-xl border transition flex items-center gap-2 text-sm font-medium shadow-sm">
                <i class="fa-solid fa-layer-group"></i> å…¨éƒ¨
            </button>

            <button onclick="setFilter('healthy')" id="btn-filter-healthy" 
                class="px-4 py-2 rounded-xl border border-stone-200 bg-white text-stone-600 hover:border-green-300 hover:bg-green-50 transition flex items-center gap-2 text-sm font-medium shadow-sm">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                å¥åº· (<span id="statHealthy">0</span>)
            </button>

            <button onclick="setFilter('thirsty')" id="btn-filter-thirsty" 
                class="px-4 py-2 rounded-xl border border-stone-200 bg-white text-stone-600 hover:border-red-300 hover:bg-red-50 transition flex items-center gap-2 text-sm font-medium shadow-sm">
                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                å£æ¸´ (<span id="statThirsty">0</span>)
            </button>
            
            <div id="dragHint" class="ml-auto text-xs text-stone-400 flex items-center gap-1 transition-opacity">
                <i class="fa-solid fa-circle-info"></i> æ‹–æ›³æ•´å¼µå¡ç‰‡å¯èª¿æ•´é †åº
            </div>
        </div>

        <!-- æ¤ç‰©åˆ—è¡¨ç¶²æ ¼ -->
        <div id="plantGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- é€™è£¡æœƒç”± JS å‹•æ…‹æ’å…¥å¡ç‰‡ -->
        </div>

        <!-- ç©ºç‹€æ…‹ (ç„¡æ¤ç‰©æ™‚é¡¯ç¤º) -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
            <div class="bg-stone-200 p-6 rounded-full mb-6">
                <i class="fa-solid fa-seedling text-4xl text-stone-400"></i>
            </div>
            <h3 class="text-xl font-bold text-stone-700 mb-2">é‚„æ²’æœ‰æ¤ç‰©å¤¥ä¼´</h3>
            <p class="text-stone-500 max-w-xs mx-auto mb-6">é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢æ¤ç‰©ã€æŒ‰éˆ•ï¼Œé–‹å§‹è¨˜éŒ„æ‚¨çš„ç¶ è‰²ç”Ÿæ´»å§ï¼</p>
            <button onclick="openAddModal()" class="text-nature-600 font-medium hover:underline">ç«‹å³æ–°å¢</button>
        </div>

    </main>

    <!-- æ–°å¢æ‡¸æµ®æŒ‰éˆ• (FAB) - æ‰‹æ©Ÿç‰ˆå°ˆç”¨ -->
    <button onclick="openAddModal()" class="md:hidden fixed bottom-8 right-6 w-14 h-14 bg-nature-600 text-white rounded-full shadow-xl shadow-nature-300 hover:bg-nature-700 hover:scale-105 active:scale-95 transition-all duration-300 z-40 flex items-center justify-center cursor-pointer" aria-label="æ–°å¢æ¤ç‰©">
        <i class="fa-solid fa-plus text-2xl"></i>
    </button>

    <footer class="bg-white border-t border-stone-200 py-6 mt-8">
        <div class="max-w-6xl mx-auto px-4 text-center text-stone-400 text-sm">
            <p>&copy; 2025 æ¤æ„Ÿç”Ÿæ´»</p>
        </div>
    </footer>

    <!-- é€šçŸ¥ Toast -->
    <div id="toast" class="fixed bottom-28 right-5 bg-stone-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-3 pointer-events-none">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toastMsg">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- åœ–ç‰‡è™•ç† Canvas (éš±è—) -->
    <canvas id="imageCanvas" class="hidden"></canvas>

    <script>
        // --- è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç† ---
        let plants = JSON.parse(localStorage.getItem('myPlants')) || [];
        let currentFilter = 'all'; 
        let sortableInstance = null;
        let tempCustomImage = null; // æš«å­˜ä¸Šå‚³çš„åœ–ç‰‡
        let plantToDeleteId = null; // æš«å­˜è¦åˆªé™¤çš„æ¤ç‰© ID

        const plantImages = [
            { id: 'plant-1', url: 'https://symbl-cdn.com/i/webp/d9/473ff79758f677cb8879408da5fc79.webp', name: 'å¤šè‚‰' },
            { id: 'plant-2', url: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTx92rCCJjkyaoA9Kp5-QqpRg7_8vWC1KOzScYiIhKtnBqV3_pt5KzTrKMJQSTEhH7kBL8&usqp=CAU', name: 'ä¸€èˆ¬' },
            { id: 'plant-3', url: 'https://images.unsplash.com/photo-1501004318641-b39e6451bec6', name: 'é¾œèƒŒèŠ‹' },
            { id: 'plant-4', url: 'https://symbl-cdn.com/i/webp/c5/75a32ad82d8b9e2b0baf5fb46a7f5d.webp', name: 'ç´è‘‰æ¦•' },
            { id: 'plant-5', url: 'https://images.unsplash.com/photo-1614594975525-e45190c55d0b', name: 'é»ƒé‡‘è‘›' },
            { id: 'plant-6', url: 'https://cdn02.pinkoi.com/wp-content/uploads/sites/7/2022/05/16034006/AnyConv.com__01-12.webp', name: 'è™å°¾è˜­' }
          ];

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            renderIconSelector();
            renderPlants();
            initSortable();
            updateFilterUI(); 
        });

        // --- æ‹–æ›³æ’åºåŠŸèƒ½ ---
        function initSortable() {
            const grid = document.getElementById('plantGrid');
            sortableInstance = new Sortable(grid, {
                animation: 150,
                filter: 'button, input, textarea, a', 
                preventOnFilter: false, 
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                delay: 100, 
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const newOrderIds = Array.from(grid.children).map(card => parseInt(card.dataset.id));
                    const plantMap = new Map(plants.map(p => [p.id, p]));
                    plants = newOrderIds.map(id => plantMap.get(id));
                    saveData();
                }
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯åŠŸèƒ½ ---
        function setFilter(filterType) {
            currentFilter = filterType;
            renderPlants();
            updateFilterUI();
        }

        function updateFilterUI() {
            const buttons = {
                'all': document.getElementById('btn-filter-all'),
                'healthy': document.getElementById('btn-filter-healthy'),
                'thirsty': document.getElementById('btn-filter-thirsty')
            };

            Object.values(buttons).forEach(btn => {
                if(btn) btn.className = 'px-4 py-2 rounded-xl border border-stone-200 bg-white text-stone-600 hover:bg-stone-50 transition flex items-center gap-2 text-sm font-medium shadow-sm';
            });

            const activeClass = 'bg-stone-800 text-white border-stone-800 hover:bg-stone-700 hover:border-stone-700 shadow-md transform scale-105';
            
            if (currentFilter === 'all' && buttons['all']) {
                buttons['all'].className = `px-4 py-2 rounded-xl border transition flex items-center gap-2 text-sm font-medium ${activeClass}`;
            } else if (currentFilter === 'healthy' && buttons['healthy']) {
                buttons['healthy'].className = `px-4 py-2 rounded-xl border border-green-500 bg-green-500 text-white hover:bg-green-600 hover:border-green-600 transition flex items-center gap-2 text-sm font-medium shadow-md transform scale-105`;
            } else if (currentFilter === 'thirsty' && buttons['thirsty']) {
                buttons['thirsty'].className = `px-4 py-2 rounded-xl border border-red-500 bg-red-500 text-white hover:bg-red-600 hover:border-red-600 transition flex items-center gap-2 text-sm font-medium shadow-md transform scale-105`;
            }

            const dragHint = document.getElementById('dragHint');
            if(dragHint) {
                if (currentFilter === 'all') {
                    if(sortableInstance) sortableInstance.option('disabled', false);
                    dragHint.classList.remove('opacity-0');
                } else {
                    if(sortableInstance) sortableInstance.option('disabled', true);
                    dragHint.classList.add('opacity-0');
                }
            }
        }

        // --- è¡¨å–® Modal ---
        function openAddModal() {
            // åŠ å…¥ overflow-hidden é˜²æ­¢èƒŒæ™¯æ²å‹•
            document.body.classList.add('overflow-hidden');
            
            resetForm();
            document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-seedling text-nature-500"></i> æ–°å¢æ‚¨çš„ç¶ è‰²å¤¥ä¼´';
            document.getElementById('submitBtnText').innerText = 'åŠ å…¥æ¸…å–®';
            document.getElementById('lastWateredDate').valueAsDate = new Date();
            showModal();
        }

        function openEditModal(id) {
            // åŠ å…¥ overflow-hidden é˜²æ­¢èƒŒæ™¯æ²å‹•
            document.body.classList.add('overflow-hidden');

            const plant = plants.find(p => p.id === id);
            if (!plant) return;

            document.getElementById('editPlantId').value = plant.id;
            document.getElementById('plantName').value = plant.name;
            document.getElementById('waterFreq').value = plant.frequency;
            document.getElementById('plantNotes').value = plant.notes || '';
            
            const date = new Date(plant.lastWatered);
            const dateString = date.toISOString().split('T')[0];
            document.getElementById('lastWateredDate').value = dateString;

            // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå®šç¾©åœ–ç‰‡ (Base64) é‚„æ˜¯é è¨­åœ–ç‰‡ URL
            const isCustomImage = plant.image.startsWith('data:image');
            
            if (isCustomImage) {
                // å¦‚æœæ˜¯è‡ªå®šç¾©åœ–ç‰‡ï¼Œè¨­å®šåˆ°æš«å­˜ä¸¦é¡¯ç¤ºåœ¨ç¬¬ä¸€å€‹é¸é …
                tempCustomImage = plant.image;
                document.getElementById('customImageData').value = plant.image;
                selectIcon('custom-upload');
                // æ›´æ–°ä¸Šå‚³æŒ‰éˆ•çš„é è¦½
                const uploadPreview = document.getElementById('uploadPreview');
                if(uploadPreview) {
                    uploadPreview.src = plant.image;
                    document.getElementById('uploadIcon').classList.add('hidden');
                    uploadPreview.classList.remove('hidden');
                }
            } else {
                // é è¨­åœ–ç‰‡
                const foundImg = plantImages.find(img => img.url === plant.image);
                selectIcon(foundImg ? foundImg.id : 'plant-1');
                tempCustomImage = null;
                document.getElementById('customImageData').value = '';
                resetUploadButton();
            }

            document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-pen-to-square text-nature-500"></i> ç·¨è¼¯æ¤ç‰©è³‡è¨Š';
            document.getElementById('submitBtnText').innerText = 'å„²å­˜ä¿®æ”¹';

            showModal();
        }

        function showModal() {
            const modal = document.getElementById('formModal');
            const content = document.getElementById('formContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeForm() {
            // ç§»é™¤ overflow-hidden æ¢å¾©èƒŒæ™¯æ²å‹•
            document.body.classList.remove('overflow-hidden');

            const modal = document.getElementById('formModal');
            const content = document.getElementById('formContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function resetForm() {
            document.getElementById('plantForm').reset();
            document.getElementById('editPlantId').value = '';
            document.getElementById('customImageData').value = '';
            tempCustomImage = null;
            resetUploadButton();
            selectIcon(plantImages[0].id);
        }

        function resetUploadButton() {
            const uploadIcon = document.getElementById('uploadIcon');
            const uploadPreview = document.getElementById('uploadPreview');
            const loader = document.getElementById('uploadLoader');
            
            if(uploadIcon) {
                uploadIcon.classList.remove('hidden', 'opacity-0');
            }
            if(uploadPreview) {
                uploadPreview.classList.add('hidden');
                uploadPreview.src = '';
            }
            if(loader) loader.classList.add('hidden');
        }

        // --- åœ–ç‰‡è™•ç† ---
        function triggerImageUpload() {
            document.getElementById('imageUploadInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // é¡¯ç¤º Loading (ä¸ç ´å£ HTML çµæ§‹)
            const loader = document.getElementById('uploadLoader');
            const icon = document.getElementById('uploadIcon');
            if(loader) loader.classList.remove('hidden');
            if(icon) icon.classList.add('opacity-0'); // éš±è—åœ–ç¤ºä½†ä¿ç•™ä½”ä½

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // å£“ç¸®èˆ‡èª¿æ•´å¤§å°
                    const canvas = document.getElementById('imageCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è¨­å®šæœ€å¤§å°ºå¯¸
                    const MAX_WIDTH = 600;
                    const MAX_HEIGHT = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¼¸å‡ºå£“ç¸®å¾Œçš„ Base64 (JPEG, 0.7 å“è³ª)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // å„²å­˜ä¸¦é è¦½
                    tempCustomImage = dataUrl;
                    document.getElementById('customImageData').value = dataUrl;
                    
                    // æ›´æ–° UI
                    const uploadPreview = document.getElementById('uploadPreview');
                    const uploadIcon = document.getElementById('uploadIcon');
                    const loader = document.getElementById('uploadLoader');
                    
                    if(uploadPreview) {
                        uploadPreview.src = dataUrl;
                        uploadPreview.classList.remove('hidden');
                    }
                    if(uploadIcon) {
                        // éš±è—åœ–ç¤º
                        uploadIcon.classList.add('hidden');
                        uploadIcon.classList.remove('opacity-0'); // ç§»é™¤æš«æ™‚çš„ opacity
                    }
                    if(loader) loader.classList.add('hidden');

                    // é¸ä¸­æ­¤é¸é …
                    selectIcon('custom-upload');
                    
                    showToast('ç…§ç‰‡ä¸Šå‚³æˆåŠŸï¼');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- è¡¨å–®æäº¤ ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('editPlantId').value;
            const name = document.getElementById('plantName').value;
            const freq = parseInt(document.getElementById('waterFreq').value);
            const iconId = document.getElementById('selectedIcon').value;
            const customData = document.getElementById('customImageData').value;
            const dateVal = document.getElementById('lastWateredDate').value;
            const notes = document.getElementById('plantNotes').value;

            // æ±ºå®šä½¿ç”¨å“ªå¼µåœ–ç‰‡ï¼šå¦‚æœæ˜¯ custom-upload ä¸”æœ‰è³‡æ–™ï¼Œå°±ç”¨è‡ªå®šç¾©çš„ï¼›å¦å‰‡æ‰¾é è¨­åœ–
            let finalImageUrl = '';
            if (iconId === 'custom-upload' && customData) {
                finalImageUrl = customData;
            } else {
                const imgObj = plantImages.find(img => img.id === iconId) || plantImages[0];
                finalImageUrl = imgObj.url;
            }

            const dateObj = new Date(dateVal);
            dateObj.setHours(12, 0, 0, 0); 
            const timestamp = dateObj.getTime();

            if (editId) {
                const index = plants.findIndex(p => p.id == editId);
                if (index !== -1) {
                    plants[index] = {
                        ...plants[index],
                        name: name,
                        frequency: freq,
                        lastWatered: timestamp,
                        image: finalImageUrl,
                        notes: notes
                    };
                    showToast('å·²æ›´æ–°æ¤ç‰©è³‡è¨Šï¼');
                }
            } else {
                const newPlant = {
                    id: Date.now(),
                    name: name,
                    frequency: freq,
                    lastWatered: timestamp, 
                    image: finalImageUrl,
                    notes: notes
                };
                plants.unshift(newPlant);
                showToast('å·²æ–°å¢æ¤ç‰©å¤¥ä¼´ï¼');
            }

            saveData();
            setFilter('all'); 
            closeForm();
        }

        // --- æ¸²æŸ“åœ–ç‰‡é¸æ“‡å™¨ ---
        function renderIconSelector() {
            const container = document.getElementById('iconSelector');
            
            // 1. ä¸Šå‚³æŒ‰éˆ• HTML
            const uploadBtnHtml = `
                <div onclick="triggerImageUpload()" 
                     id="option-custom-upload"
                     class="cursor-pointer rounded-lg overflow-hidden border-2 border-dashed border-stone-300 hover:border-nature-500 hover:bg-stone-50 transition relative h-14 md:h-16 w-full icon-option flex items-center justify-center group" 
                     data-id="custom-upload">
                    
                    <!-- Loading Spinner (é è¨­éš±è—) -->
                    <div id="uploadLoader" class="hidden absolute inset-0 flex items-center justify-center bg-stone-50 z-20">
                        <div class="loader"></div>
                    </div>

                    <!-- é è¨­é¡¯ç¤ºç›¸æ©Ÿåœ–ç¤º -->
                    <div id="uploadIcon" class="flex flex-col items-center justify-center text-stone-400 group-hover:text-nature-600 transition-opacity duration-200">
                        <i class="fa-solid fa-camera text-xl mb-0.5"></i>
                        <span class="text-[10px] font-medium">æ‹ç…§/ä¸Šå‚³</span>
                    </div>

                    <!-- ä¸Šå‚³å¾Œçš„é è¦½åœ– (é è¨­éš±è—) -->
                    <img id="uploadPreview" src="" class="hidden w-full h-full object-cover absolute inset-0 z-10">
                    
                    <!-- é¸ä¸­æ™‚çš„é®ç½© (JS æ§åˆ¶) -->
                    <div id="uploadCheckOverlay" class="hidden absolute inset-0 bg-nature-500/20 flex items-center justify-center z-30">
                        <i class="fa-solid fa-check text-white drop-shadow-md"></i>
                    </div>
                </div>
            `;

            // 2. é è¨­åœ–ç‰‡ HTML
            const presetsHtml = plantImages.map((img, index) => `
                <div onclick="selectIcon('${img.id}')" 
                     class="cursor-pointer rounded-lg overflow-hidden border-2 ${index === 0 ? 'border-nature-500 ring-2 ring-nature-200' : 'border-transparent'} hover:border-nature-300 transition relative h-14 md:h-16 w-full icon-option preset-option" 
                     data-id="${img.id}">
                    <img src="${img.url}" class="w-full h-full object-cover">
                    ${index === 0 ? '<div class="absolute inset-0 bg-nature-500/20 flex items-center justify-center"><i class="fa-solid fa-check text-white drop-shadow-md"></i></div>' : ''}
                </div>
            `).join('');

            container.innerHTML = uploadBtnHtml + presetsHtml;
            document.getElementById('selectedIcon').value = plantImages[0].id;
        }

        function selectIcon(id) {
            // å¦‚æœé¸çš„æ˜¯è‡ªå®šç¾©ä¸Šå‚³ï¼Œä½†é‚„æ²’ä¸Šå‚³åœ–ç‰‡ï¼Œå‰‡è§¸ç™¼ä¸Šå‚³çª—
            if (id === 'custom-upload' && !document.getElementById('customImageData').value && !tempCustomImage) {
                triggerImageUpload();
                return;
            }

            // é‡ç½®æ‰€æœ‰é¸é …æ¨£å¼
            document.querySelectorAll('.icon-option').forEach(el => {
                // æ¢å¾©ä¸Šå‚³æŒ‰éˆ•çš„ dashed border
                if(el.id === 'option-custom-upload') {
                    el.classList.remove('border-nature-500', 'ring-2', 'ring-nature-200', 'border-solid');
                    el.classList.add('border-stone-300', 'border-dashed');
                    document.getElementById('uploadCheckOverlay').classList.add('hidden');
                } else {
                    el.classList.remove('border-nature-500', 'ring-2', 'ring-nature-200');
                    el.classList.add('border-transparent');
                    // ç§»é™¤ä¸€èˆ¬é¸é …çš„é®ç½©
                    const overlay = el.querySelector('div.absolute');
                    if(overlay) overlay.remove();
                }
            });

            // è¨­å®šé¸ä¸­é …ç›®æ¨£å¼
            const selected = document.querySelector(`.icon-option[data-id="${id}"]`);
            if(selected) {
                if (id === 'custom-upload') {
                    selected.classList.remove('border-stone-300', 'border-dashed');
                    selected.classList.add('border-nature-500', 'ring-2', 'ring-nature-200', 'border-solid');
                    document.getElementById('uploadCheckOverlay').classList.remove('hidden');
                } else {
                    selected.classList.remove('border-transparent');
                    selected.classList.add('border-nature-500', 'ring-2', 'ring-nature-200');
                    selected.innerHTML += '<div class="absolute inset-0 bg-nature-500/20 flex items-center justify-center"><i class="fa-solid fa-check text-white drop-shadow-md"></i></div>';
                }
                document.getElementById('selectedIcon').value = id;
            }
        }

        // 4. åˆªé™¤æ¤ç‰©
        function deletePlant(id) {
            // ä½¿ç”¨è‡ªå®šç¾© Modal å–ä»£ confirm()ï¼Œé¿å…åœ¨ iframe ä¸­è¢«é˜»æ“‹
            plantToDeleteId = id;
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('deleteModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeDeleteModal() {
            plantToDeleteId = null;
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('deleteModalContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function confirmDelete() {
            if (plantToDeleteId) {
                plants = plants.filter(p => p.id !== plantToDeleteId);
                saveData();
                renderPlants();
                showToast('å·²ç§»é™¤æ¤ç‰©');
                closeDeleteModal();
            }
        }

        // 5. å¿«é€Ÿæ¾†æ°´å‹•ä½œ
        function waterPlant(id) {
            const plant = plants.find(p => p.id === id);
            if (plant) {
                plant.lastWatered = Date.now();
                saveData();
                renderPlants();
                showToast(`å·²å¹« ${plant.name} è£œå……æ°´åˆ†ï¼ğŸ’§`);
            }
        }

        // 6. è¨ˆç®—èˆ‡æ¸²æŸ“åˆ—è¡¨
        function renderPlants() {
            const grid = document.getElementById('plantGrid');
            const emptyState = document.getElementById('emptyState');
            const statsBar = document.getElementById('statsBar');
            
            grid.innerHTML = '';
            
            if (plants.length === 0) {
                emptyState.classList.remove('hidden');
                statsBar.classList.add('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
                statsBar.classList.remove('hidden');
            }

            let healthyCount = 0;
            let thirstyCount = 0;

            plants.forEach(plant => {
                if (needsWater(plant)) thirstyCount++;
                else healthyCount++;
            });

            const filteredPlants = plants.filter(plant => {
                const isThirsty = needsWater(plant);
                if (currentFilter === 'healthy') return !isThirsty;
                if (currentFilter === 'thirsty') return isThirsty;
                return true; 
            });

            filteredPlants.forEach(plant => {
                const now = Date.now();
                const diffTime = now - plant.lastWatered;
                const diffDays = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
                const daysLeft = plant.frequency - diffDays;
                
                const isThirsty = daysLeft <= 0;
                
                const borderClass = isThirsty 
                    ? 'ring-2 ring-red-400 border-red-200 shadow-red-100' 
                    : 'border-stone-100 hover:border-nature-300 hover:shadow-lg';
                
                const statusBadge = isThirsty
                    ? `<span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1"><i class="fa-solid fa-droplet"></i> å£æ¸´äº†ï¼</span>`
                    : `<span class="bg-nature-100 text-nature-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1"><i class="fa-solid fa-check"></i> å¥åº·</span>`;

                const daysText = isThirsty
                    ? `<span class="text-red-500 font-bold">å·²å»¶é² ${Math.abs(daysLeft)} å¤©</span>`
                    : `<span class="text-stone-500">é‚„æœ‰ ${daysLeft} å¤©</span>`;

                const progressBarColor = isThirsty ? 'bg-red-400' : 'bg-nature-500';
                let progressPercent = Math.max(0, (daysLeft / plant.frequency) * 100);
                if (isThirsty) progressPercent = 0;

                const notesHtml = plant.notes 
                    ? `<div class="mt-3 pt-3 border-t border-dashed border-stone-200 text-xs text-stone-500 italic truncate"><i class="fa-regular fa-note-sticky mr-1"></i> ${plant.notes}</div>` 
                    : '';
                
                const draggableClass = currentFilter === 'all' ? 'draggable-card' : '';

                const cardHTML = `
                    <div class="card-enter bg-white rounded-2xl overflow-hidden shadow-sm transition-all duration-300 relative group border ${borderClass} plant-card ${draggableClass}" data-id="${plant.id}">
                        
                        <div class="absolute top-3 right-3 flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition z-10">
                            <button onclick="event.stopPropagation(); openEditModal(${plant.id})" class="bg-white/90 p-2 rounded-full text-stone-500 hover:text-nature-600 shadow-sm hover:shadow-md transition" title="ç·¨è¼¯">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deletePlant(${plant.id})" class="bg-white/90 p-2 rounded-full text-stone-400 hover:text-red-500 shadow-sm hover:shadow-md transition" title="åˆªé™¤">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>

                        <div class="flex h-32 relative">
                            <div class="w-1/3 overflow-hidden pl-2 py-2">
                                <img src="${plant.image}" class="w-full h-full object-cover plant-img rounded-lg" alt="${plant.name}">
                            </div>
                            <div class="w-2/3 p-4 flex flex-col justify-between relative bg-gradient-to-r from-transparent to-stone-50/50">
                                <div class="pl-2">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="text-lg font-bold text-stone-800 truncate pr-6" title="${plant.name}">${plant.name}</h3>
                                    </div>
                                    <div class="flex items-center gap-2 mb-2">
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="text-xs text-stone-400 pl-2">
                                    <i class="fa-regular fa-clock mr-1"></i> é »ç‡ï¼šæ¯ ${plant.frequency} å¤©
                                </div>
                            </div>
                        </div>

                        <div class="px-5 py-4 border-t border-stone-50">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-sm text-stone-500">ä¸‹æ¬¡æ¾†æ°´</span>
                                <span class="text-sm">${daysText}</span>
                            </div>
                            
                            <div class="w-full h-2 bg-stone-100 rounded-full mb-4 overflow-hidden">
                                <div class="h-full ${progressBarColor} rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                            </div>

                            <button onclick="event.stopPropagation(); waterPlant(${plant.id})" 
                                class="w-full py-2.5 rounded-xl flex items-center justify-center gap-2 font-medium transition water-btn 
                                ${isThirsty 
                                    ? 'bg-red-500 hover:bg-red-600 text-white shadow-red-200 shadow-md animate-pulse' 
                                    : 'bg-nature-50 text-nature-700 hover:bg-nature-100 border border-nature-200'}">
                                <i class="fa-solid fa-faucet-drip"></i> 
                                ${isThirsty ? 'å¿«å¹«æˆ‘æ¾†æ°´ï¼' : 'è¨˜éŒ„æ¾†æ°´'}
                            </button>
                            
                            <div class="flex justify-between items-center mt-2 text-[10px] text-stone-300">
                                <span>ä¸Šæ¬¡ï¼š${new Date(plant.lastWatered).toLocaleDateString()}</span>
                            </div>

                            ${notesHtml}
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHTML;
            });

            const statHealthyEl = document.getElementById('statHealthy');
            const statThirstyEl = document.getElementById('statThirsty');
            if(statHealthyEl) statHealthyEl.innerText = healthyCount;
            if(statThirstyEl) statThirstyEl.innerText = thirstyCount;
        }

        function needsWater(plant) {
            const now = Date.now();
            const diffTime = now - plant.lastWatered;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= plant.frequency;
        }

        function saveData() {
            try {
                localStorage.setItem('myPlants', JSON.stringify(plants));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('å„²å­˜å¤±æ•—ï¼åœ–ç‰‡å¯èƒ½å¤ªå¤šæˆ–å¤ªå¤§ï¼Œè«‹å˜—è©¦åˆªé™¤ä¸€äº›æ¤ç‰©ã€‚');
                } else {
                    showToast('å„²å­˜æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚');
                }
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            msgEl.innerText = msg;
            
            toast.classList.remove('translate-y-20', 'opacity-0', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0', 'pointer-events-none');
            }, 3000);
        }
    </script>
</body>
</html>